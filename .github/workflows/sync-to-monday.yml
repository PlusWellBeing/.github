name: Sync GitHub Issues to Monday

on:
  workflow_call:
    secrets:
      MONDAY_API_TOKEN:
        required: true
      GH_ORG_PAT:
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue and resolve parent feature task
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ORG_PAT || github.token }}
          script: |
            const body = context.payload.issue.body || '';
            const estimateMatch = body.match(/### Estimate \(Hours\)\s*\n\s*(\d+(?:\.\d+)?)/);
            const estimateHours = estimateMatch ? parseFloat(estimateMatch[1]) : 0;

            core.setOutput('estimate_hours', estimateHours);
            core.setOutput('issue_number', context.payload.issue.number);
            core.setOutput('issue_url', context.payload.issue.html_url);
            core.setOutput('issue_state', context.payload.issue.state);
            core.setOutput('repo_name', context.payload.repository.name);

            // Find parent issue via sub-issues API
            const token = await core.getIDToken().catch(() => null);
            const response = await fetch('https://api.github.com/graphql', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${{ secrets.GH_ORG_PAT || github.token }}`,
                'Content-Type': 'application/json',
                'GraphQL-Features': 'sub_issues'
              },
              body: JSON.stringify({
                query: `
                  query {
                    node(id: "${context.payload.issue.node_id}") {
                      ... on Issue {
                        parent {
                          number
                          body
                          repository {
                            owner { login }
                            name
                          }
                        }
                      }
                    }
                  }
                `
              })
            });

            const result = await response.json();
            const parent = result.data?.node?.parent;
            if (!parent) {
              core.info('No parent issue found. Skipping Monday sync.');
              core.setOutput('has_monday_id', 'false');
              return;
            }

            const parentBody = parent.body || '';
            const mondayIdMatch = parentBody.match(/### Monday Item ID\s*\n\s*(\d+)/) || parentBody.match(/monday\.com\/boards\/\d+\/pulses\/(\d+)/);

            if (!mondayIdMatch) {
              core.info('Parent issue does not have a Monday Item ID. Skipping.');
              core.setOutput('has_monday_id', 'false');
              return;
            }

            const mondayItemId = mondayIdMatch[1];
            const parentRef = `${parent.repository.owner.login}/${parent.repository.name}#${parent.number}`;

            core.setOutput('has_monday_id', 'true');
            core.setOutput('monday_item_id', mondayItemId);
            core.setOutput('parent_owner', parent.repository.owner.login);
            core.setOutput('parent_repo', parent.repository.name);
            core.setOutput('parent_number', parent.number);

            core.info(`Parent: ${parentRef}, Monday ID: ${mondayItemId}, Estimate: ${estimateHours}h`);

      - name: Calculate rolled-up estimate
        if: steps.parse.outputs.has_monday_id == 'true'
        id: rollup
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ORG_PAT || github.token }}
          script: |
            const parentOwner = '${{ steps.parse.outputs.parent_owner }}';
            const parentRepo = '${{ steps.parse.outputs.parent_repo }}';
            const parentNumber = parseInt('${{ steps.parse.outputs.parent_number }}');
            const mondayId = '${{ steps.parse.outputs.monday_item_id }}';

            // Get all sub-issues of the parent feature task
            const response = await fetch('https://api.github.com/graphql', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${{ secrets.GH_ORG_PAT || github.token }}`,
                'Content-Type': 'application/json',
                'GraphQL-Features': 'sub_issues'
              },
              body: JSON.stringify({
                query: `
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        subIssues(first: 100) {
                          nodes {
                            number
                            title
                            state
                            body
                            repository {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                `,
                variables: {
                  owner: parentOwner,
                  repo: parentRepo,
                  number: parentNumber
                }
              })
            });

            const result = await response.json();
            const subIssues = result.data.repository.issue.subIssues.nodes;

            let totalEstimate = 0;
            let openCount = 0;
            let closedCount = 0;
            const linkedIssues = [];

            for (const issue of subIssues) {
              const body = issue.body || '';
              const estMatch = body.match(/### Estimate \(Hours\)\s*\n\s*(\d+(?:\.\d+)?)/);
              const hours = estMatch ? parseFloat(estMatch[1]) : 0;

              totalEstimate += hours;
              linkedIssues.push({
                number: issue.number,
                repo: issue.repository.name,
                title: issue.title,
                state: issue.state,
                estimate: hours
              });

              if (issue.state === 'OPEN') openCount++;
              else closedCount++;
            }

            let mondayStatus;
            if (openCount === 0 && closedCount > 0) {
              mondayStatus = 'Done';
            } else if (openCount > 0 && closedCount > 0) {
              mondayStatus = 'Working on it';
            } else {
              mondayStatus = 'Assigned';
            }

            core.setOutput('total_estimate', totalEstimate);
            core.setOutput('monday_status', mondayStatus);
            core.setOutput('open_count', openCount);
            core.setOutput('closed_count', closedCount);

            core.info(`Rollup: ${totalEstimate}h total (${openCount} open, ${closedCount} closed) -> ${mondayStatus}`);
            core.info(`Linked issues: ${JSON.stringify(linkedIssues, null, 2)}`);

      - name: Update Monday item
        if: steps.parse.outputs.has_monday_id == 'true'
        uses: actions/github-script@v7
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
        with:
          script: |
            const mondayItemId = '${{ steps.parse.outputs.monday_item_id }}';
            const totalEstimate = parseFloat('${{ steps.rollup.outputs.total_estimate }}');
            const mondayStatus = '${{ steps.rollup.outputs.monday_status }}';
            const boardId = '18332167710';

            const columnValues = JSON.stringify({
              numbers: String(totalEstimate),
              status__design: { label: mondayStatus }
            });

            const mutation = `
              mutation ($boardId: ID!, $itemId: ID!, $columnValues: JSON!) {
                change_multiple_column_values(
                  board_id: $boardId
                  item_id: $itemId
                  column_values: $columnValues
                ) {
                  id
                }
              }
            `;

            const response = await fetch('https://api.monday.com/v2', {
              method: 'POST',
              headers: {
                'Authorization': process.env.MONDAY_API_TOKEN,
                'Content-Type': 'application/json',
                'API-Version': '2024-10'
              },
              body: JSON.stringify({
                query: mutation,
                variables: {
                  boardId: boardId,
                  itemId: mondayItemId,
                  columnValues: columnValues
                }
              })
            });

            const data = await response.json();

            if (data.errors) {
              core.setFailed(`Monday API errors: ${JSON.stringify(data.errors)}`);
              return;
            }
            if (data.error_message) {
              core.setFailed(`Monday API error: ${data.error_message}`);
              return;
            }

            core.info(`Updated Monday item ${mondayItemId}: ${totalEstimate}h, status=${mondayStatus}`);

      - name: Sync Monday subitem
        if: steps.parse.outputs.has_monday_id == 'true'
        uses: actions/github-script@v7
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
        with:
          script: |
            const mondayItemId = '${{ steps.parse.outputs.monday_item_id }}';
            const issueTitle = context.payload.issue.title;
            const issueUrl = context.payload.issue.html_url;
            const issueNumber = '${{ steps.parse.outputs.issue_number }}';
            const repoName = context.payload.repository.name;
            const estimate = parseFloat('${{ steps.parse.outputs.estimate_hours }}') || 0;
            const issueState = context.payload.issue.state;
            const subitemBoardId = '18365228709';

            const prefix = `[${repoName}] #${issueNumber}`;
            const subitemName = `${prefix} - ${issueTitle}`;

            const headers = {
              'Authorization': process.env.MONDAY_API_TOKEN,
              'Content-Type': 'application/json',
              'API-Version': '2024-10'
            };

            async function findSubitem(parentId) {
              const query = `
                query ($itemId: [ID!]!) {
                  items(ids: $itemId) {
                    subitems {
                      id
                      name
                    }
                  }
                }
              `;
              const res = await fetch('https://api.monday.com/v2', {
                method: 'POST', headers,
                body: JSON.stringify({ query, variables: { itemId: [parentId] } })
              });
              const data = await res.json();
              const subitems = data.data?.items?.[0]?.subitems || [];
              return subitems.find(s => s.name.startsWith(prefix));
            }

            try {
              const existing = await findSubitem(mondayItemId);

              if (existing) {
                const subitemStatus = issueState === 'closed' ? 'Done' : 'Working on it';
                const columnValues = JSON.stringify({
                  status: { label: subitemStatus },
                  numeric_mm0p6e06: String(estimate)
                });

                const mutation = `
                  mutation ($boardId: ID!, $itemId: ID!, $columnValues: JSON!) {
                    change_multiple_column_values(board_id: $boardId, item_id: $itemId, column_values: $columnValues) { id }
                  }
                `;
                const res = await fetch('https://api.monday.com/v2', {
                  method: 'POST', headers,
                  body: JSON.stringify({
                    query: mutation,
                    variables: { boardId: subitemBoardId, itemId: existing.id, columnValues }
                  })
                });
                const data = await res.json();
                if (data.errors) core.warning(`Subitem update errors: ${JSON.stringify(data.errors)}`);
                else core.info(`Updated subitem ${existing.id}: estimate=${estimate}h, status=${subitemStatus}`);
              } else {
                const columnValues = JSON.stringify({
                  status: { label: 'Working on it' },
                  link_mm0pht2g: { url: issueUrl, text: `#${issueNumber}` },
                  numeric_mm0p6e06: String(estimate)
                });

                const mutation = `
                  mutation ($parentItemId: ID!, $itemName: String!, $columnValues: JSON!) {
                    create_subitem(parent_item_id: $parentItemId, item_name: $itemName, column_values: $columnValues) { id }
                  }
                `;
                const res = await fetch('https://api.monday.com/v2', {
                  method: 'POST', headers,
                  body: JSON.stringify({
                    query: mutation,
                    variables: { parentItemId: mondayItemId, itemName: subitemName, columnValues }
                  })
                });
                const data = await res.json();
                if (data.errors) core.warning(`Subitem create errors: ${JSON.stringify(data.errors)}`);
                else core.info(`Created subitem on Monday item ${mondayItemId}: ${subitemName}`);
              }
            } catch (err) {
              core.warning(`Failed to sync Monday subitem: ${err.message}`);
            }
