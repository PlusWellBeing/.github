name: Sync Monday Items to Feature Board

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync Monday items to GitHub feature tasks
        uses: actions/github-script@v7
        env:
          MONDAY_API_TOKEN: ${{ secrets.MONDAY_API_TOKEN }}
        with:
          github-token: ${{ secrets.GH_ORG_PAT || github.token }}
          script: |
            const boardId = '18332167710';

            // Monday user ID -> GitHub username mapping
            const mondayToGithub = {
              '96239704': 'Badams1',
              '69730181': 'cwdcwd',
              '69729944': 'ericrosenkranz',
              '96230374': 'a-mirecki',
              '96232936': 'carlos-henrique-dev',
              '97332747': 'tjrunnels',
              '98887492': 'Jbj2001',
              '99805863': 'KonradWinkowski',
              '77430520': 'denalimason',
              '95360615': 'shanifargun',
              '78392946': 'eskimm'
            };

            const headers = {
              'Authorization': process.env.MONDAY_API_TOKEN,
              'Content-Type': 'application/json',
              'API-Version': '2024-10'
            };

            // Determine current and next week's Monday dates
            const now = new Date();
            const dayOfWeek = now.getUTCDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const thisMonday = new Date(now);
            thisMonday.setUTCDate(now.getUTCDate() + mondayOffset);
            thisMonday.setUTCHours(0, 0, 0, 0);

            const nextMonday = new Date(thisMonday);
            nextMonday.setUTCDate(thisMonday.getUTCDate() + 7);

            const nextFriday = new Date(nextMonday);
            nextFriday.setUTCDate(nextMonday.getUTCDate() + 4);

            core.info(`Current week: ${thisMonday.toISOString().slice(0, 10)}, Next week ends: ${nextFriday.toISOString().slice(0, 10)}`);

            // Fetch board groups and find current + next week
            const groupsQuery = `query { boards(ids: [${boardId}]) { groups { id title } } }`;
            const groupsRes = await fetch('https://api.monday.com/v2', {
              method: 'POST', headers,
              body: JSON.stringify({ query: groupsQuery })
            });
            const groupsData = await groupsRes.json();
            const allGroups = groupsData.data.boards[0].groups;

            // Parse group titles like "February 16-20" or "November 10-14, 2025"
            const months = { january: 0, february: 1, march: 2, april: 3, may: 4, june: 5,
              july: 6, august: 7, september: 8, october: 9, november: 10, december: 11 };

            const targetGroupIds = [];
            for (const group of allGroups) {
              const match = group.title.match(/^(\w+)\s+(\d+)\s*[-â€“]\s*(\d+)(?:,?\s*(\d{4}))?$/i);
              if (!match) continue;

              const month = months[match[1].toLowerCase()];
              if (month === undefined) continue;

              const startDay = parseInt(match[2]);
              const year = match[4] ? parseInt(match[4]) : now.getUTCFullYear();
              const groupStart = new Date(Date.UTC(year, month, startDay));

              // Group matches if it overlaps with current week or next week
              if (groupStart >= thisMonday && groupStart <= nextFriday) {
                targetGroupIds.push(group.id);
                core.info(`Matched group: "${group.title}" (${group.id})`);
              }
            }

            if (targetGroupIds.length === 0) {
              core.info('No matching groups found for current/next week. Nothing to sync.');
              return;
            }

            // Fetch items from matched groups, filtered by "Sync to GitHub" checkbox
            let allItems = [];
            for (const groupId of targetGroupIds) {
              const query = `query {
                boards(ids: [${boardId}]) {
                  groups(ids: ["${groupId}"]) {
                    items_page(limit: 100) {
                      items {
                        id
                        name
                        column_values(ids: ["boolean_mm0rhtf7", "multiple_person_mm0d8pta"]) {
                          id
                          text
                          value
                        }
                      }
                    }
                  }
                }
              }`;

              const res = await fetch('https://api.monday.com/v2', {
                method: 'POST', headers,
                body: JSON.stringify({ query })
              });
              const data = await res.json();

              if (data.errors) {
                core.setFailed(`Monday API errors: ${JSON.stringify(data.errors)}`);
                return;
              }

              const items = data.data.boards[0].groups[0].items_page.items;
              // Only include items where "Sync to GitHub" checkbox is checked
              for (const item of items) {
                const checkCol = item.column_values.find(c => c.id === 'boolean_mm0rhtf7');
                if (!checkCol || checkCol.text !== 'v') continue;

                // Extract owner Monday user IDs
                const peopleCol = item.column_values.find(c => c.id === 'multiple_person_mm0d8pta');
                const assignees = [];
                if (peopleCol && peopleCol.value && peopleCol.value !== 'null') {
                  try {
                    const parsed = JSON.parse(peopleCol.value);
                    const personIds = (parsed.personsAndTeams || [])
                      .filter(p => p.kind === 'person')
                      .map(p => String(p.id));
                    for (const pid of personIds) {
                      assignees.push(mondayToGithub[pid] || 'Badams1');
                    }
                  } catch {}
                }
                if (assignees.length === 0) assignees.push('Badams1');
                item.assignees = [...new Set(assignees)];
                allItems.push(item);
              }
            }

            core.info(`Found ${allItems.length} items with "Sync to GitHub" checked in current/next week groups`);

            if (allItems.length === 0) return;

            // Fetch all existing feature tasks in one pass
            const existingMondayIds = new Set();
            let page = 1;
            while (true) {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'feature-task',
                state: 'all',
                per_page: 100,
                page: page
              });
              if (issues.length === 0) break;
              for (const issue of issues) {
                const match = (issue.body || '').match(/### Monday Item ID\s*\n\s*(\d+)/) || (issue.body || '').match(/monday\.com\/boards\/\d+\/pulses\/(\d+)/);
                if (match) existingMondayIds.add(match[1]);
              }
              page++;
            }

            core.info(`Found ${existingMondayIds.size} existing feature tasks`);

            // Create feature tasks for new Monday items only
            let created = 0;
            for (const item of allItems) {
              if (existingMondayIds.has(String(item.id))) {
                continue;
              }

              const mondayUrl = `https://plus-wellbeing.monday.com/boards/18332167710/pulses/${item.id}`;
              const body = [
                `<!-- ### Monday Item ID`,
                `${item.id}`,
                `-->`,
                ``,
                `**Monday item:** [${item.name}](${mondayUrl})`,
                ``,
                `---`,
                ``,
                `*Add implementation tasks as sub-issues (make sure to select repository destination)*`
              ].join('\n');

              const createParams = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: item.name,
                body: body,
                labels: ['feature-task']
              };
              if (item.assignees.length > 0) {
                createParams.assignees = item.assignees;
              }
              const { data: issue } = await github.rest.issues.create(createParams);

              core.info(`Created feature task #${issue.number} for Monday item ${item.id}: ${item.name}`);
              created++;

              // Rate limit: pause between creations
              await new Promise(r => setTimeout(r, 1000));
            }

            core.info(`Done. Created ${created} new feature tasks.`);
